AWSTemplateFormatVersion: 2010-09-09
Description: Governance Portfolio
Metadata:
  'AWS::CloudFormation::Interface':
    ParameterGroups:
      - Label:
          default: Portfolio Information
        Parameters:
          - PorfolioName
          - PortfolioProvider
          - PorfolioDescription
      - Label:
          default: IAM Settings
        Parameters:
          - LaunchRoleName
          - LinkedRole1
          - LinkedRole2
          - CreateEndUsers
      - Label:
          default: Product Settings
        Parameters:
          - RepoRootURL
Parameters:
  PortfolioProvider:
    Type: String
    Description: Provider Name
    Default: IT Services
  PorfolioName:
    Type: String
    Description: Portfolio Name
    Default: Service Catalog AccountBuilder
  PorfolioDescription:
    Type: String
    Description: Portfolio Description
    Default: >-
      Service Catalog Portfolio that contains governance products.
  LaunchRoleName:
    Type: String
    Description: >-
      Name of the launch constraint role for Governance products. leave this blank to
      create the role.
  LinkedRole1:
    Type: String
    Description: >-
      (Optional) The name of a role which can execute products in this
      portfolio.
  LinkedRole2:
    Type: String
    Description: >-
      (Optional) The name of a second role which can execute products in this
      portfolio.
  RepoRootURL:
    Type: String
    Description: S3 root url for the repository containing the product templates.
    Default: 'https://organization-repo.s3.amazonaws.com/'
  CreateEndUsers:
    Type: String
    Description: >-
      Select Yes to Create the ServiceCatalogEndusers IAM group. No if you have
      already created the group
    AllowedValues:
      - 'Yes'
      - 'No'
    Default: 'Yes'
  ProductEmailAlert:
    Type: String
    Description: Email address where SNS notifications will be sent.
    Default: 'shnc@capgroup.com'
  CGPrincipalID:
    Type: String
    Description: Principal ID of the master account.
    Default: 'o-1eax4cor5e'

Conditions:
  CreateLaunchConstraint: !Equals 
    - !Ref LaunchRoleName
    - ''
  CondCreateEndUsers: !Equals 
    - !Ref CreateEndUsers
    - 'Yes'
  CondLinkRole1: !Not 
    - !Equals 
      - !Ref LinkedRole1
      - ''
  CondLinkRole2: !Not 
    - !Equals 
      - !Ref LinkedRole2
      - ''
Resources:
  SCGovernanceportfolio:
    Type: 'AWS::ServiceCatalog::Portfolio'
    Properties:
      ProviderName: !Ref PortfolioProvider
      Description: !Ref PorfolioDescription
      DisplayName: !Ref PorfolioName
  addrole1:
    Type: 'AWS::ServiceCatalog::PortfolioPrincipalAssociation'
    Condition: CondLinkRole1
    Properties:
      PrincipalARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/${LinkedRole1}'
      PortfolioId: !Ref SCGovernanceportfolio
      PrincipalType: IAM
  addrole2:
    Type: 'AWS::ServiceCatalog::PortfolioPrincipalAssociation'
    Condition: CondLinkRole2
    Properties:
      PrincipalARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/${LinkedRole2}'
      PortfolioId: !Ref SCGovernanceportfolio
      PrincipalType: IAM
  snowenduserrole:
    Type: 'AWS::ServiceCatalog::PortfolioPrincipalAssociation'
    DependsOn:
      - SCGovernanceportfolio
      - SnowEndUser
    Properties:
      AcceptLanguage: en
      PortfolioId: !Ref SCGovernanceportfolio
      PrincipalARN: !GetAtt 
        - SnowEndUser
        - Arn
      PrincipalType: IAM
  LaunchConstraintRole:
    Type: 'AWS::CloudFormation::Stack'
    Condition: CreateLaunchConstraint
    Properties:
      TemplateURL: !Sub '${RepoRootURL}servicecatalog/sc-governance-launchrole.yml'
      TimeoutInMinutes: 5
  stackServiceCatalogEndusers:
    Type: 'AWS::CloudFormation::Stack'
    Condition: CondCreateEndUsers
    Properties:
      TemplateURL: !Sub '${RepoRootURL}servicecatalog/sc-enduser-iam.yml'
      TimeoutInMinutes: 5
  LinkEndusersRole:
    Type: 'AWS::ServiceCatalog::PortfolioPrincipalAssociation'
    Properties:
      PrincipalARN: !If 
        - CondCreateEndUsers
        - !GetAtt 
          - stackServiceCatalogEndusers
          - Outputs.EndUserRoleArn
        - !Sub 'arn:aws:iam::${AWS::AccountId}:role/ServiceCatalogEndusers'
      PortfolioId: !Ref SCGovernanceportfolio
      PrincipalType: IAM
  LinkEndusersGroup:
    Type: 'AWS::ServiceCatalog::PortfolioPrincipalAssociation'
    Properties:
      PrincipalARN: !If 
        - CondCreateEndUsers
        - !GetAtt 
          - stackServiceCatalogEndusers
          - Outputs.EndUserGroupArn
        - !Sub 'arn:aws:iam::${AWS::AccountId}:group/ServiceCatalogEndusers'
      PortfolioId: !Ref SCGovernanceportfolio
      PrincipalType: IAM
  SnowEndUser:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: SnowEndUser
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AWSServiceCatalogEndUserFullAccess'
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub 'arn:aws:iam::${AWS::AccountId}:root'
            Action:
              - 'sts:AssumeRole'
      Policies:
        - PolicyName: StackSet
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: GetRole
                Effect: Allow
                Action:
                  - 'iam:GetRole'
                  - 'iam:PassRole'
                Resource: !Sub >-
                  arn:aws:iam::${AWS::AccountId}:role/AWSCloudFormationStackSetAdministrationRole
        - PolicyName: ServiceCatalogServiceNowAdditionalPermissions
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: GetRole
                Effect: Allow
                Action:
                  - 'iam:GetRole'
                  - 'iam:PassRole'
                Resource: !Sub >-
                  arn:aws:iam::${AWS::AccountId}:role/AWSCloudFormationStackSetAdministrationRole
  SCEndUser:
    Type: 'AWS::IAM::User'
    DependsOn:
      - SnowEndUser
    Properties:
      UserName: SCEndUser
      Policies:
        - PolicyName: StsAssumeSC
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Effect: Allow
                Action:
                  - 'sts:AssumeRole'
                Resource: !GetAtt 
                  - SnowEndUser
                  - Arn
  SCSyncUser:
    Type: 'AWS::IAM::User'
    Properties:
      UserName: SCSyncUser
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/AWSServiceCatalogAdminReadOnlyAccess'
      Policies:
        - PolicyName: SSMActionPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: SCConnectorAdminSID
                Effect: Allow
                Action:
                  - 'servicecatalog:DeleteProduct'
                  - 'servicecatalog:DeleteConstraint'
                  - 'servicecatalog:DeleteProvisionedProductPlan'
                  - 'servicecatalog:DeleteProvisioningArtifact'
                  - 'servicecatalog:DisassociateProductFromPortfolio'
                  - 'servicecatalog:ListBudgetsForResource'
                  - 'budgets:ViewBudget'
                Resource: '*'
  SCSyncUserAccessKeys:
    DependsOn: SCSyncUser
    Type: 'AWS::IAM::AccessKey'
    Properties:
      Status: Active
      UserName: SCSyncUser
  AccountBuilderOnScheduleProduct:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      Parameters:
        PortfolioProvider: !Ref PortfolioProvider
        LaunchConstraintARN: !If 
          - CreateLaunchConstraint
          - !GetAtt 
            - LaunchConstraintRole
            - Outputs.LaunchRoleArn
          - !Sub 'arn:aws:iam::${AWS::AccountId}:role/${LaunchRoleName}'
        PortfolioId: !Ref SCGovernanceportfolio
        RepoRootURL: !Ref RepoRootURL
        ServiceCatalogGovernanceTopic: !Ref ServiceCatalogGovernanceTopic
      TemplateURL: !Sub '${RepoRootURL}servicecatalog/account-builder/scheduler/sc-product-accountbuilderonschedule.yml'
      TimeoutInMinutes: 5
  ABOnScheduleLifecycleProduct:
    Type: 'AWS::CloudFormation::Stack'
    Properties:
      Parameters:
        PortfolioProvider: !Ref PortfolioProvider
        LaunchConstraintARN: !If 
          - CreateLaunchConstraint
          - !GetAtt 
            - LaunchConstraintRole
            - Outputs.LaunchRoleArn
          - !Sub 'arn:aws:iam::${AWS::AccountId}:role/${LaunchRoleName}'
        PortfolioId: !Ref SCGovernanceportfolio
        RepoRootURL: !Ref RepoRootURL
        ServiceCatalogGovernanceTopic: !Ref ServiceCatalogGovernanceTopic
      TemplateURL: !Sub '${RepoRootURL}servicecatalog/account-builder/scheduler/sc-product-abonschedulelifecycle.yml'
      TimeoutInMinutes: 5
  ServiceCatalogGovernanceTopic:
    Type: 'AWS::SNS::Topic'
    Properties:
      TopicName: "ServiceCatalogGovernanceTopic"
      Subscription:
        - Endpoint: !Ref ProductEmailAlert
          Protocol: email
  ServiceCatalogGovernanceTopicPolicy:
    Type: AWS::SNS::TopicPolicy
    Properties:
      PolicyDocument:
        Id: ServiceCatalogGovernanceTopicPolicy
        Version: 2008-10-17
        Statement:
          - Sid: Access-Only-To-Master-Account
            Effect: Allow
            Principal:
              AWS: '*'
            Action:
              - 'SNS:Publish'
              - 'SNS:RemovePermission'
              - 'SNS:SetTopicAttributes'
              - 'SNS:DeleteTopic'
              - 'SNS:ListSubscriptionsByTopic'
              - 'SNS:GetTopicAttributes'
              - 'SNS:Receive'
              - 'SNS:AddPermission'
              - 'SNS:Subscribe'
            Resource: !Ref 'ServiceCatalogGovernanceTopic'
            Condition:
              StringEquals:
                'AWS:SourceOwner': !Ref 'AWS::AccountId'
          - Sid: Publish-Access-to-member-accounts
            Effect: Allow
            Principal:
              AWS: '*'
            Action: 'SNS:Publish'
            Resource: !Ref 'ServiceCatalogGovernanceTopic'
            Condition:
              StringEquals:
                'aws:PrincipalOrgID': !Ref CGPrincipalID
      Topics:
      - !Ref ServiceCatalogGovernanceTopic
Outputs:
  EndUserRoleArn:
    Condition: CondCreateEndUsers
    Value: !GetAtt 
      - stackServiceCatalogEndusers
      - Outputs.EndUserRoleArn
  EndUserGroupArn:
    Condition: CondCreateEndUsers
    Value: !GetAtt 
      - stackServiceCatalogEndusers
      - Outputs.EndUserGroupArn
  EndUserGroupName:
    Condition: CondCreateEndUsers
    Value: !GetAtt 
      - stackServiceCatalogEndusers
      - Outputs.EndUserGroupName
  LaunchConstraintRoleARN:
    Condition: CreateLaunchConstraint
    Value: !GetAtt 
      - LaunchConstraintRole
      - Outputs.LaunchRoleArn
  LaunchConstraintRoleName:
    Condition: CreateLaunchConstraint
    Value: !GetAtt 
      - LaunchConstraintRole
      - Outputs.LaunchRoleName
