AWSTemplateFormatVersion: 2010-09-09
Description: 'Spoke setup CloudFormation Template.'
Mappings: 
  PortfolioID: 
    us-east-1: 
      "ID": "port-nlor7j75iak3a"
  S3ProductID: 
    us-east-1: 
      "ID": "prod-2ymhtbjylicus"
  BudgetProductID: 
    us-east-1: 
      "ID": "prod-hopvnhiqrt3hi"
  KMSProductID: 
    us-east-1: 
      "ID": "prod-qfwkfhqojg4da"
Resources:
  SCEndUserTestPortfolio:
    Type: "AWS::ServiceCatalog::Portfolio"
    Properties:
      AcceptLanguage: "en"
      Description: "This portfolio enables end users to provision products within their account"
      DisplayName: "End-User-Test-Portfolio"
      ProviderName: "CCOE"
  LinkedRole3PortfolioPrincipalAssociation:
    Type: "AWS::ServiceCatalog::PortfolioPrincipalAssociation"
    Properties:
      AcceptLanguage: "en"
      PortfolioId: !Ref SCEndUserTestPortfolio
      PrincipalARN: !Sub 'arn:aws:iam::${AWS::AccountId}:role/OrganizationAccountAccessRole'
      PrincipalType: "IAM"
  S3EndUserPortfolioProductAssociation:
    Type: "AWS::ServiceCatalog::PortfolioProductAssociation"
    Properties:
      AcceptLanguage: "en"
      PortfolioId: !Ref SCEndUserTestPortfolio
      ProductId: !FindInMap [S3ProductID, !Ref "AWS::Region", 'ID']  
      SourcePortfolioId:  !FindInMap [PortfolioID, !Ref "AWS::Region", 'ID'] 
  S3LaunchConstraint:
    Type: "AWS::ServiceCatalog::LaunchRoleConstraint"
    DependsOn:
      - SCEndUserTestPortfolio
      - SCEndUserTestS3ProductLaunchRole
    Properties:
      AcceptLanguage: "en"
      Description: "The launch constraint for s3 bucket products"
      PortfolioId: !Ref SCEndUserTestPortfolio
      ProductId: !FindInMap [S3ProductID, !Ref "AWS::Region", 'ID']  
      RoleArn: !GetAtt SCEndUserTestS3ProductLaunchRole.Arn
  SCEndUserTestS3ProductLaunchRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: SCEndUserTestS3ProductLaunchRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - servicecatalog.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: SCLaunchPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: SCLaunchPolicySID
                Effect: Allow
                Action:                  
                  - "servicecatalog:ListServiceActionsForProvisioningArtifact"
                  - "servicecatalog:ExecuteprovisionedProductServiceAction"
                  - "iam:AddRoleToInstanceProfile"
                  - "iam:ListRolePolicies"
                  - "iam:ListPolicies"
                  - "iam:DeleteRole"
                  - "iam:GetRole"
                  - "iam:CreateInstanceProfile"
                  - "iam:PassRole"
                  - "iam:DeleteInstanceProfile"
                  - "iam:ListRoles"
                  - "iam:RemoveRoleFromInstanceProfile"
                  - "iam:CreateRole"
                  - "iam:DetachRolePolicy"
                  - "iam:AttachRolePolicy"                                 
                  - "cloudformation:DescribeStackResource"
                  - "cloudformation:DescribeStackResources"
                  - "cloudformation:GetTemplate"
                  - "cloudformation:List*"
                  - "cloudformation:DescribeStackEvents"
                  - "cloudformation:DescribeStacks"
                  - "cloudformation:CreateStack"
                  - "cloudformation:DeleteStack"
                  - "cloudformation:DescribeStackEvents"
                  - "cloudformation:DescribeStacks"
                  - "cloudformation:GetTemplateSummary"
                  - "cloudformation:SetStackPolicy"
                  - "cloudformation:ValidateTemplate"
                  - "cloudformation:UpdateStack"               
                  - "s3:GetObject"
                  - "lambda:InvokeFunction"
                Resource: '*'
  BudgetEndUserPortfolioProductAssociation:
    Type: "AWS::ServiceCatalog::PortfolioProductAssociation"
    Properties:
      AcceptLanguage: "en"
      PortfolioId: !Ref SCEndUserTestPortfolio
      ProductId: !FindInMap [BudgetProductID, !Ref "AWS::Region", 'ID']  
      SourcePortfolioId:  !FindInMap [PortfolioID, !Ref "AWS::Region", 'ID'] 
  BudgetLaunchConstraint:
    Type: "AWS::ServiceCatalog::LaunchRoleConstraint"
    DependsOn:
      - SCEndUserTestPortfolio
      - SCEndUserTestBudgetProductLaunchRole
    Properties:
      AcceptLanguage: "en"
      Description: "The launch constraint for Budget bucket products"
      PortfolioId: !Ref SCEndUserTestPortfolio
      ProductId: !FindInMap [BudgetProductID, !Ref "AWS::Region", 'ID']  
      RoleArn: !GetAtt SCEndUserTestBudgetProductLaunchRole.Arn
  SCEndUserTestBudgetProductLaunchRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: SCEndUserTestBudgetProductLaunchRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - servicecatalog.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: SCLaunchPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: SCLaunchPolicySID
                Effect: Allow
                Action:                  
                  - "servicecatalog:ListServiceActionsForProvisioningArtifact"
                  - "servicecatalog:ExecuteprovisionedProductServiceAction"
                  - "iam:AddRoleToInstanceProfile"
                  - "iam:ListRolePolicies"
                  - "iam:ListPolicies"
                  - "iam:DeleteRole"
                  - "iam:GetRole"
                  - "iam:CreateInstanceProfile"
                  - "iam:PassRole"
                  - "iam:DeleteInstanceProfile"
                  - "iam:ListRoles"
                  - "iam:RemoveRoleFromInstanceProfile"
                  - "iam:CreateRole"
                  - "iam:DetachRolePolicy"
                  - "iam:AttachRolePolicy"                                 
                  - "cloudformation:DescribeStackResource"
                  - "cloudformation:DescribeStackResources"
                  - "cloudformation:GetTemplate"
                  - "cloudformation:List*"
                  - "cloudformation:DescribeStackEvents"
                  - "cloudformation:DescribeStacks"
                  - "cloudformation:CreateStack"
                  - "cloudformation:DeleteStack"
                  - "cloudformation:DescribeStackEvents"
                  - "cloudformation:DescribeStacks"
                  - "cloudformation:GetTemplateSummary"
                  - "cloudformation:SetStackPolicy"
                  - "cloudformation:ValidateTemplate"
                  - "cloudformation:UpdateStack"               
                  - "s3:GetObject"
                  - "budgets:ModifyBudget"
                Resource: '*'
  KMSEndUserPortfolioProductAssociation:
    Type: "AWS::ServiceCatalog::PortfolioProductAssociation"
    Properties:
      AcceptLanguage: "en"
      PortfolioId: !Ref SCEndUserTestPortfolio
      ProductId: !FindInMap [KMSProductID, !Ref "AWS::Region", 'ID']  
      SourcePortfolioId:  !FindInMap [PortfolioID, !Ref "AWS::Region", 'ID'] 
  KMSLaunchConstraint:
    Type: "AWS::ServiceCatalog::LaunchRoleConstraint"
    DependsOn:
      - SCEndUserTestPortfolio
      - SCEndUserTestKMSProductLaunchRole
    Properties:
      AcceptLanguage: "en"
      Description: "The launch constraint for KMS products"
      PortfolioId: !Ref SCEndUserTestPortfolio
      ProductId: !FindInMap [KMSProductID, !Ref "AWS::Region", 'ID']  
      RoleArn: !GetAtt SCEndUserTestKMSProductLaunchRole.Arn
  SCEndUserTestKMSProductLaunchRole:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: SCEndUserTestKMSProductLaunchRole
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - servicecatalog.amazonaws.com
            Action:
              - 'sts:AssumeRole'
      Path: /
      Policies:
        - PolicyName: SCLaunchPolicy
          PolicyDocument:
            Version: 2012-10-17
            Statement:
              - Sid: SCLaunchPolicySID
                Effect: Allow
                Action:                  
                  - "servicecatalog:ListServiceActionsForProvisioningArtifact"
                  - "servicecatalog:ExecuteprovisionedProductServiceAction"
                  - "iam:AddRoleToInstanceProfile"
                  - "iam:ListRolePolicies"
                  - "iam:ListPolicies"
                  - "iam:DeleteRole"
                  - "iam:GetRole"
                  - "iam:CreateInstanceProfile"
                  - "iam:PassRole"
                  - "iam:DeleteInstanceProfile"
                  - "iam:ListRoles"
                  - "iam:RemoveRoleFromInstanceProfile"
                  - "iam:CreateRole"
                  - "iam:DetachRolePolicy"
                  - "iam:AttachRolePolicy"                                 
                  - "cloudformation:DescribeStackResource"
                  - "cloudformation:DescribeStackResources"
                  - "cloudformation:GetTemplate"
                  - "cloudformation:List*"
                  - "cloudformation:DescribeStackEvents"
                  - "cloudformation:DescribeStacks"
                  - "cloudformation:CreateStack"
                  - "cloudformation:DeleteStack"
                  - "cloudformation:DescribeStackEvents"
                  - "cloudformation:DescribeStacks"
                  - "cloudformation:GetTemplateSummary"
                  - "cloudformation:SetStackPolicy"
                  - "cloudformation:ValidateTemplate"
                  - "cloudformation:UpdateStack"               
                  - "s3:GetObject"
                  - "sns:Publish"
                Resource: '*'
Outputs:
    S3LaunchRoleArn:
        Value: !GetAtt SCEndUserTestS3ProductLaunchRole.Arn
    S3LaunchRoleName:
        Value: !Ref SCEndUserTestS3ProductLaunchRole
    S3EndUserPortfolioProductAssociation:
        Value: !Ref S3EndUserPortfolioProductAssociation
    BudgetLaunchRoleArn:
        Value: !GetAtt SCEndUserTestBudgetProductLaunchRole.Arn
    BudgetLaunchRoleName:
        Value: !Ref SCEndUserTestBudgetProductLaunchRole
    BudgetEndUserPortfolioProductAssociation:
        Value: !Ref BudgetEndUserPortfolioProductAssociation
    KMSLaunchRoleArn:
        Value: !GetAtt SCEndUserTestKMSProductLaunchRole.Arn
    KMSLaunchRoleName:
        Value: !Ref SCEndUserTestKMSProductLaunchRole
    KMSEndUserPortfolioProductAssociation:
        Value: !Ref KMSEndUserPortfolioProductAssociation