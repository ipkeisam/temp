AWSTemplateFormatVersion: 2010-09-09
Description: KMS Keys provisioning ServiceCatalog product.
Parameters:
  PortfolioProvider:
    Type: String
    Description: Owner and Distributor Name
  LaunchConstraintARN:
    Type: String
    Description: ARN of the launch constraint role for kms-keys products.
  PortfolioId:
    Type: String
    Description: The ServiceCatalog portfolio this product will be attached to.
  RepoRootURL:
    Type: String
    Description: Root url for the repo containing the product templates.
  ServiceCatalogGovernanceTopic:
    Type: String
    Description: ARN of SNS Topic that receives notifications when kms-keys product is created.
Resources:
  sckmskeysproduct:
    Type: 'AWS::ServiceCatalog::CloudFormationProduct'
    Properties:
      Name: Create KMS Keys for an account
      Description: >-
        This product creates new KMS keys within an account
      Owner: !Ref PortfolioProvider
      Distributor: !Ref PortfolioProvider
      SupportDescription: Cloud Support Team
      SupportEmail: PDS_-_Platform_Design_services@capgroup.com
      AcceptLanguage: en
      SupportUrl: 'http://capitalgroup.service-now.com'
      ProvisioningArtifactParameters:
        - Description: baseline version
          Info:
            LoadTemplateFromURL: !Sub '${RepoRootURL}servicecatalog/CFKMSKeysSelfService.yml'
          Name: v1.0
  AssociateKMSKeys:
    Type: 'AWS::ServiceCatalog::PortfolioProductAssociation'
    Properties:
      PortfolioId: !Ref PortfolioId
      ProductId: !Ref sckmskeysproduct
  ConstraintKMSKeys:
    Type: 'AWS::ServiceCatalog::LaunchRoleConstraint'
    DependsOn: AssociateKMSKeys
    Properties:
      PortfolioId: !Ref PortfolioId
      ProductId: !Ref sckmskeysproduct
      RoleArn: !Ref LaunchConstraintARN
      Description: !Ref LaunchConstraintARN

  KMSKeysCreatedLaunchNotification:
    Type: "AWS::ServiceCatalog::LaunchNotificationConstraint"
    Properties:
      Description: "Publishes notifications when KMS keys are created for an account."
      NotificationArns: 
        - !Ref ServiceCatalogGovernanceTopic
      PortfolioId: !Ref PortfolioId
      ProductId: !Ref sckmskeysproduct
    DependsOn: AssociateKMSKeys
Outputs:
  ProductId:
    Value: !Ref sckmskeysproduct