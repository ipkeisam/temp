{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "Template to create subnets for a given environment.",

  "Metadata": {
    "Version": "1.0",
    "LastUpdated": "2017-10-31",
    "UpdatedBy": "Daren Westman (dwestman@trace3.com)"
  },

  "Parameters": {
    "AdmCidrs" : {
      "Type": "CommaDelimitedList",
      "Description": "CIDR block for the Admin subnet"
    },
    "WebCidrs" : {
      "Type": "CommaDelimitedList",
      "Description": "CIDR block for the Web subnet"
    },
	"WebVipCidrs" : {
      "Type": "CommaDelimitedList",
      "Description": "CIDR block for the Web VIPs subnet"
	},
    "AppCidrs" : {
      "Type": "CommaDelimitedList",
      "Description": "CIDR block for the App subnet"
    },
    "Vpc": {
      "Type": "String",
      "Description": "ID of the VpcId to modify"
    },
    "PrivateRoute": {
      "Type": "String",
      "Description": "ID of the Private Route Table to associate with the new subnets"
    },
    "PublicRoute": {
      "Type": "String",
      "Description": "ID of the Public Route Table to associate with the new subnets"
    },
    "nwAcl": {
      "Type": "String",
      "Description": "ID of the Network ACL to associate with the new subnets"
    },
    "Project" : {
      "Type" : "String",
      "Description" : "Project tag"
    },
    "Environment" : {
      "Type" : "String",
      "Description" : "Environment tag"
    },
    "EnvStack" : {
      "Type" : "String",
      "Description" : "Stack tag"
    }
  },

  "Resources": {     
    "AdmSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "Vpc" },
        "AvailabilityZone": "us-west-2a",
        "CidrBlock": { "Fn::Select": [ "0", {"Ref": "AdmCidrs"} ] },
        "Tags": [
          { "Key" : "Name", "Value" :  { "Fn::Join" : ["-", [ { "Ref" : "Project" }, { "Ref" : "Environment" }, "adm", "2a" ]] } },
          { "Key": "Environment", "Value": { "Ref" : "Environment" } },
          { "Key": "Stack", "Value": { "Ref" : "EnvStack"} }
        ]
      }
    },

    "WebSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "Vpc" },
        "AvailabilityZone": "us-west-2a",
        "CidrBlock": { "Fn::Select": [ "0", {"Ref": "WebCidrs"} ] },
        "MapPublicIpOnLaunch": "True",
        "Tags": [
          { "Key" : "Name", "Value" :  { "Fn::Join" : ["-", [ { "Ref" : "Project" }, { "Ref" : "Environment" }, "web", "2a" ]] } },
          { "Key": "Environment", "Value": { "Ref" : "Environment" } },
          { "Key": "Stack", "Value": { "Ref" : "EnvStack"} }
        ]
      }
    },

	"WebVipSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "Vpc" },
        "AvailabilityZone": "us-west-2a",
        "CidrBlock": { "Fn::Select": [ "0", {"Ref": "WebVipCidrs"} ] },
        "MapPublicIpOnLaunch": "False",
        "Tags": [
          { "Key" : "Name", "Value" :  { "Fn::Join" : ["-", [ { "Ref" : "Project" }, { "Ref" : "Environment" }, "webvip", "2a" ]] } },
          { "Key": "Environment", "Value": { "Ref" : "Environment" } },
          { "Key": "Stack", "Value": { "Ref" : "EnvStack"} }
        ]
      }
    },
	
    "AppSubnet1": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "VpcId": { "Ref": "Vpc" },
        "AvailabilityZone": "us-west-2a",
        "CidrBlock": { "Fn::Select": [ "0", {"Ref": "AppCidrs"} ] },
        "Tags": [
          { "Key" : "Name", "Value" :  { "Fn::Join" : ["-", [ { "Ref" : "Project" }, { "Ref" : "Environment" }, "app", "2a" ]] } },
          { "Key": "Environment", "Value": { "Ref" : "Environment" } },
          { "Key": "Stack", "Value": { "Ref" : "EnvStack"} }
        ]
      }
    },

    "RouteTableAssociation1": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
          "SubnetId": { "Ref": "AdmSubnet1" },
          "RouteTableId": { "Ref": "PrivateRoute" }
      }
    },
	"RouteTableAssociation2": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
          "SubnetId": { "Ref": "WebVipSubnet1" },
          "RouteTableId": { "Ref": "PrivateRoute" }
      }
    },
    "RouteTableAssociation4": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
          "SubnetId": { "Ref": "WebSubnet1" },
          "RouteTableId": { "Ref": "PublicRoute" }
      }
    },
    "RouteTableAssociation7": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
          "SubnetId": { "Ref": "AppSubnet1" },
          "RouteTableId": { "Ref": "PrivateRoute" }
      }
    },

    "SubnetDev1ToAcl": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
          "SubnetId": { "Ref": "AdmSubnet1" },
          "NetworkAclId": { "Ref": "nwAcl" }
      }
    },
    "SubnetDev4ToAcl": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
          "SubnetId": { "Ref": "WebSubnet1" },
          "NetworkAclId": { "Ref": "nwAcl" }
      }
    },
	"SubnetDev2ToAcl": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
          "SubnetId": { "Ref": "WebVipSubnet1" },
          "NetworkAclId": { "Ref": "nwAcl" }
      }
    },
    "SubnetDev7ToAcl": {
      "Type": "AWS::EC2::SubnetNetworkAclAssociation",
      "Properties": {
          "SubnetId": { "Ref": "AppSubnet1" },
          "NetworkAclId": { "Ref": "nwAcl" }
      }
    }
  },

  "Outputs": {
    "VpcId": {
        "Description": "Id of the modified VPC",
        "Value": { "Ref": "Vpc" }
    },
    "ACLId": {
        "Description": "Id of the modified Network ACL",
        "Value": { "Ref": "nwAcl" }
    },
    "PublicRT": {
        "Description": "ID of the Public Route Table to associate with the new subnets",
        "Value": { "Ref": "PublicRoute" }
    },
    "PrivateRT": {
        "Description": "ID of the Private Route Table to associate with the new subnets",
        "Value": { "Ref": "PrivateRoute" }
    },

    "SubnetAdm1": {
        "Description": "ID of the new admin subnet 1",
        "Value": { "Ref": "AdmSubnet1" }
    },
    "SubnetWeb1": {
        "Description": "ID of the new web subnet 1",
        "Value": { "Ref": "WebSubnet1" }
    },
    "SubnetApp1": {
        "Description": "ID of the new app subnet 1",
        "Value": { "Ref": "AppSubnet1" }
    }
  }
}
