{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "Template to assign static routes to to all subnets created in the parent stack. NOTE: The VPN ConnectionId is passed as a parameter from the calling CloudFormation stack.",

  "Metadata": {
    "Version": "1.0",
    "LastUpdated": "2017-12-19",
    "UpdatedBy": "Jim Lentz (jlentz@trace3.com)"
  },

  "Parameters": {
    "ConnectionId": {
        "Type": "String",
        "Description": "Name of the VPN Connection where the static routes are added"
      },
    "CidrList" : {
      "Type" : "CommaDelimitedList",
      "Description" : "A list of internal CIDR blocks used for routing"
    },
	"Env" : {
      "Type" : "String",
      "Description" : "A list of internal CIDR blocks used for routing"
    },
	"VpcId" : {
      "Type" : "String",
      "Description" : "A list of internal CIDR blocks used for routing"
    },
	"VPNGatewayId" : {
      "Type" : "String",
      "Description" : "VPN Gateway ID"
    },
	"InternetGateway" : {
      "Type" : "String",
      "Description" : "Internet Gateway ID"
    },
	"VpcCider" : {
	  "Type" : "String",
	  "Description" : "IP Block for the VPC"
	},
	"DMZExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the DMZ Subnet Exist?"
	},
	"WebVIPExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the Web VIP Subnet Exist?"
	},
	"WebExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the Web Subnet Exist?"
	},
	"AppVIPExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the App VIP Subnet Exist?"
	},
	"AppExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the App Subnet Exist?"
	},
	"AdmExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the Admin Subnet Exist?"
	},
	"ProjectId" : {
	  "Type" : "String",
	  "Description" : "Name of the Project"
	},
	"AZ": {
      "Type": "CommaDelimitedList",
      "Description": "ID of the AvailabilityZone"
    }
  },
  "Conditions" : {
     "DMZExists": { 
		  "Fn::Equals": [ {"Ref": "DMZExistsA"}, "True"]
	 },
	 "WebVIPExists": { 
		  "Fn::Equals": [ {"Ref": "WebVIPExistsA"}, "True"]
	 },
	 "WebExists": { 
		  "Fn::Equals": [ {"Ref": "WebExistsA"}, "True"]
	 },
	 "AppVIPExists": { 
		  "Fn::Equals": [ {"Ref": "AppVIPExistsA"}, "True"]
	 },
	 "AppExists": { 
		  "Fn::Equals": [ {"Ref": "AppExistsA"}, "True"]
	 },
	 "AdmExists": { 
		  "Fn::Equals": [ {"Ref": "AdmExistsA"}, "True"]
	 },
	 "VPNExists": { 
	   "Fn::Not": [ {"Fn::Equals": [ {"Ref": "VPNGatewayId"}, "False"]} ]
     },
     "CreateDMZ": {
         "Fn::And": [{"Condition":"DMZExists"}, {"Condition": "VPNExists"}]
     },
     "CreateAdm": {
        "Fn::And": [{"Condition":"AdmExists"}, {"Condition": "VPNExists"}]
    }
  },
  "Resources": {
    "StaticRoute1": {
	      "Condition": "VPNExists",
          "Type": "AWS::EC2::VPNConnectionRoute",
          "Properties": {
              "DestinationCidrBlock": { "Fn::Select": [ "0", {"Ref": "CidrList"} ] },
              "VpnConnectionId": { "Ref": "ConnectionId" }
          }
    },
  

	"AdmRouteTable": {
	    "Condition": "CreateAdm",
        "Type": "AWS::EC2::RouteTable",
        "Properties": {
            "VpcId": { "Ref": "VpcId" },
            "Tags": [
                { "Key" : "Environment", "Value" : { "Ref" : "Env" } },
                { "Key" : "Name", "Value" : { "Fn::Join" : ["-", [ { "Ref" : "ProjectId" }, "rt", "Adm", { "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] } ]] } }
            ]
        }
    },
	"AdmPrivRoute": {
	    "Condition": "CreateAdm",
        "Type": "AWS::EC2::Route",
		"Properties": {
            "RouteTableId": { "Ref": "AdmRouteTable" },
            "DestinationCidrBlock": { "Fn::Select": [ "0", {"Ref": "CidrList"} ] },
            "GatewayId": { "Ref": "VPNGatewayId" }
        }
	},
	
	
	"WebVIPRouteTable": {
		"Condition": "WebVIPExists",
        "Type": "AWS::EC2::RouteTable",
        "Properties": {
            "VpcId": { "Ref": "VpcId" },
            "Tags": [
                { "Key" : "Environment", "Value" : { "Ref" : "Env" } },
                { "Key" : "Name", "Value" : { "Fn::Join" : ["-", [ { "Ref" : "ProjectId" }, "rt", "WebVIP", { "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] } ]] } }
            ]
        }
    },
	"WebVIPPrivRoute": {
	    "Condition": "WebVIPExists",
        "Type": "AWS::EC2::Route",
		"Properties": {
            "RouteTableId": { "Ref": "WebVIPRouteTable" },
            "DestinationCidrBlock": { "Fn::Select": [ "0", {"Ref": "CidrList"} ] },
            "GatewayId": { "Ref": "VPNGatewayId" }
        }
	},
	
	"WebRouteTable": {
	    "Condition": "WebExists",
        "Type": "AWS::EC2::RouteTable",
        "Properties": {
            "VpcId": { "Ref": "VpcId" },
            "Tags": [
                { "Key" : "Environment", "Value" : { "Ref" : "Env" } },
                { "Key" : "Name", "Value" : { "Fn::Join" : ["-", [ { "Ref" : "ProjectId" }, "rt", "Web", { "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] } ]] } }
            ]
        }
    },
	"WebPrivRoute": {
	    "Condition": "WebExists",
        "Type": "AWS::EC2::Route",
		"Properties": {
            "RouteTableId": { "Ref": "WebRouteTable" },
            "DestinationCidrBlock": { "Fn::Select": [ "0", {"Ref": "CidrList"} ] },
            "GatewayId": { "Ref": "VPNGatewayId" }
        }
	},
	
	"AppVIPRouteTable": {
	    "Condition": "AppVIPExists",
        "Type": "AWS::EC2::RouteTable",
        "Properties": {
            "VpcId": { "Ref": "VpcId" },
            "Tags": [
                { "Key" : "Environment", "Value" : { "Ref" : "Env" } },
                { "Key" : "Name", "Value" : { "Fn::Join" : ["-", [ { "Ref" : "ProjectId" }, "rt", "AppVIP", { "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] } ]] } }
            ]
        }
    },
	"AppVIPPrivRoute": {
	    "Condition": "AppVIPExists",
        "Type": "AWS::EC2::Route",
		"Properties": {
            "RouteTableId": { "Ref": "AppVIPRouteTable" },
            "DestinationCidrBlock": { "Fn::Select": [ "0", {"Ref": "CidrList"} ] },
            "GatewayId": { "Ref": "VPNGatewayId" }
        }
	},
	
	"AppRouteTable": {
	    "Condition": "AppExists",
        "Type": "AWS::EC2::RouteTable",
        "Properties": {
            "VpcId": { "Ref": "VpcId" },
            "Tags": [
                { "Key" : "Environment", "Value" : { "Ref" : "Env" } },
                { "Key" : "Name", "Value" : { "Fn::Join" : ["-", [ { "Ref" : "ProjectId" }, "rt", "App", { "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] } ]] } }
            ]
        }
    },
	"AppPrivRoute": {
	    "Condition": "AppExists",
        "Type": "AWS::EC2::Route",
		"Properties": {
            "RouteTableId": { "Ref": "AppRouteTable" },
            "DestinationCidrBlock": { "Fn::Select": [ "0", {"Ref": "CidrList"} ] },
            "GatewayId": { "Ref": "VPNGatewayId" }
        }
	},
	
	
	
	"DMZRouteTable": {
	    "Condition": "CreateDMZ",
        "Type": "AWS::EC2::RouteTable",
        "Properties": {
            "VpcId": { "Ref": "VpcId" },
            "Tags": [
                { "Key": "Environment", "Value": { "Ref": "Env" } },
                { "Key" : "Name", "Value" : { "Fn::Join" : ["-", [ { "Ref" : "ProjectId" }, "rt", "DMZ", { "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] } ]] } }
            ]
        }
    },
    "DMZRoute": {
	    "Condition": "CreateDMZ",
        "Type": "AWS::EC2::Route",
        "Properties": {
            "RouteTableId": { "Ref": "DMZRouteTable" },
            "DestinationCidrBlock": "0.0.0.0/0",
            "GatewayId": { "Ref": "InternetGateway" }
        }
    }
    	
  },

  "Outputs": {
      "ConnectionId": {
          "Description": "Reference ID for the VPN connection",
          "Value": { "Ref": "ConnectionId" }
	  },
	  "AdmRoute": {
	      "Condition": "AdmExists",
          "Description": "Reference ID for the Admin Subnet Route Table",
          "Value": { "Ref": "AdmRouteTable" }
      },
	  
	  "WebVIPRoute": {
		  "Condition": "WebVIPExists",
          "Description": "Reference ID for the Web VIP Subnet Route Table",
          "Value": { "Ref": "WebVIPRouteTable" }
      },
	  "WebRoute": {
	      "Condition": "WebExists",
          "Description": "Reference ID for the Web Subnet Route Table",
          "Value": { "Ref": "WebRouteTable" }
      },
	  "AppVIPRoute": {
	      "Condition": "AppVIPExists",
          "Description": "Reference ID for the App VIP Subnet Route Table",
          "Value": { "Ref": "AppVIPRouteTable" }
      },
	  "AppRoute": {
	      "Condition": "AppExists",
          "Description": "Reference ID for the App Subnet Route Table",
          "Value": { "Ref": "AppRouteTable" }
      },
	  "DMZRouteTable": {
	      "Condition": "DMZExists",
          "Description": "Reference ID for the DMZ Route Table",
          "Value": { "Ref": "DMZRouteTable" }
      }
  }
}
