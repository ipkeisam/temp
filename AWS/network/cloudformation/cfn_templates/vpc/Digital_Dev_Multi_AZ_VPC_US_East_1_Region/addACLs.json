{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "Template to create a set of ACLs, and add them to an existing VPC. NOTE: The ID of the VPC to update is passed as a parameter from a calling CloudFormation stack. The Availability Zone, CIDR block, and Tag values are hardcoded herein.",

  "Metadata": {
      "Version": "1.0",
      "LastUpdated": "2017-10-31",
      "UpdatedBy": "Daren Westman (dwestman@trace3.com)"
  },

  "Parameters": {
    "VPCID": {
        "Type": "String",
        "Description": "ID of the VPC to modify"
    },
    "Environment" : {
      "Type" : "String",
      "Description" : "The environment where the resources will be built"
    },
    "Project" : {
      "Type" : "String",
      "Description" : "Project tag ('mh')"
    },
	"AZ": {
      "Type": "CommaDelimitedList",
      "Description": "ID of the AvailabilityZone"
    },
    "CidrList" : {
      "Type" : "CommaDelimitedList",
      "Description" : "A comma-delimited list of static IPs providing internal network access"
    },
	"DMZExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the DMZ Subnet Exist?"
	},
	"WebVIPExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the Web VIP Subnet Exist?"
	},
	"WebExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the Web Subnet Exist?"
	},
	"AppVIPExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the App VIP Subnet Exist?"
	},
	"AppExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the App Subnet Exist?"
	},
	"AdmExistsA" : {
	  "Type" : "String",
	  "Description" : "Does the Admin Subnet Exist?"
	}
  },
  "Conditions" : {
     "DMZExists": { 
		  "Fn::Equals": [ {"Ref": "DMZExistsA"}, "True"]
	 },
	 "WebVIPExists": { 
		  "Fn::Equals": [ {"Ref": "WebVIPExistsA"}, "True"]
	 },
	 "WebExists": { 
		  "Fn::Equals": [ {"Ref": "WebExistsA"}, "True"]
	 },
	 "AppVIPExists": { 
		  "Fn::Equals": [ {"Ref": "AppVIPExistsA"}, "True"]
	 },
	 "AppExists": { 
		  "Fn::Equals": [ {"Ref": "AppExistsA"}, "True"]
	 },
	 "AdmExists": { 
		  "Fn::Equals": [ {"Ref": "AdmExistsA"}, "True"]
	 }
  },
  "Resources": {

      "DMZNetworkAcl": {
	      "Condition": "DMZExists",
          "Type": "AWS::EC2::NetworkAcl",
          "Properties": {
              "VpcId": { "Ref": "VPCID" },
              "Tags": [
                  { "Key" : "Name", "Value" :  { "Fn::Join" : ["-", [ { "Ref" : "Project" }, "dmz",{ "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] }, "nacl" ]] } },
                  { "Key": "Environment", "Value": { "Ref": "Environment" } },
                  { "Key": "Network", "Value": "DMZ" }
              ]
          }
      },
	  "InboundAcl1": {
	      "Condition": "DMZExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "DMZNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "false",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },
	  "OutboundAcl1": {
	      "Condition": "DMZExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "DMZNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "true",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },

      "WebVIPNetworkAcl": {
	      "Condition": "WebVIPExists",
          "Type": "AWS::EC2::NetworkAcl",
          "Properties": {
              "VpcId": { "Ref": "VPCID" },
              "Tags": [
                  { "Key" : "Name", "Value" :  { "Fn::Join" : ["-", [ { "Ref" : "Project" }, "webVIP",{ "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] }, "nacl" ]] } },
                  { "Key": "Environment", "Value": { "Ref": "Environment" } },
                  { "Key": "Network", "Value": "WebVIP" }
              ]
          }
      },
	  "InboundAcl2": {
	      "Condition": "WebVIPExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "WebVIPNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "false",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },
	  "OutboundAcl2": {
	      "Condition": "WebVIPExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "WebVIPNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "true",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },
      "WebNetworkAcl": {
	      "Condition": "WebExists",
          "Type": "AWS::EC2::NetworkAcl",
          "Properties": {
              "VpcId": { "Ref": "VPCID" },
              "Tags": [
                  { "Key" : "Name", "Value" :  { "Fn::Join" : ["-", [ { "Ref" : "Project" }, "web",{ "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] }, "nacl" ]] } },
                  { "Key": "Environment", "Value": { "Ref": "Environment" } },
                  { "Key": "Network", "Value": "web" }
              ]
          }
      },
	  "InboundAcl3": {
	      "Condition": "WebExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "WebNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "false",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },
	  "OutboundAcl3": {
	      "Condition": "WebExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "WebNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "true",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },
      "AppVIPNetworkAcl": {
	      "Condition": "AppVIPExists",
          "Type": "AWS::EC2::NetworkAcl",
          "Properties": {
              "VpcId": { "Ref": "VPCID" },
              "Tags": [
                  { "Key" : "Name", "Value" :  { "Fn::Join" : ["-", [ { "Ref" : "Project" }, "appVIP",{ "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] }, "nacl" ]] } },
                  { "Key": "Environment", "Value": { "Ref": "Environment" } },
                  { "Key": "Network", "Value": "appVIP" }
              ]
          }
      },
	  "InboundAcl4": {
	      "Condition": "AppVIPExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "AppVIPNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "false",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },
	  "OutboundAcl4": {
	      "Condition": "AppVIPExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "AppVIPNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "true",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },
      "AppNetworkAcl": {
	      "Condition": "AppExists",
          "Type": "AWS::EC2::NetworkAcl",
          "Properties": {
              "VpcId": { "Ref": "VPCID" },
              "Tags": [
                  { "Key" : "Name", "Value" :  { "Fn::Join" : ["-", [ { "Ref" : "Project" }, "app",{ "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] }, "nacl" ]] } },
                  { "Key": "Environment", "Value": { "Ref": "Environment" } },
                  { "Key": "Network", "Value": "app" }
              ]
          }
      },
	  "InboundAcl5": {
	      "Condition": "AppExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "AppNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "false",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },
	  "OutboundAcl5": {
	      "Condition": "AppExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "AppNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "true",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },

	  
	  "AdmNetworkAcl": {
	      "Condition": "AdmExists",
          "Type": "AWS::EC2::NetworkAcl",
          "Properties": {
              "VpcId": { "Ref": "VPCID" },
              "Tags": [
                  { "Key" : "Name", "Value" :  { "Fn::Join" : ["-", [ { "Ref" : "Project" }, "adm",{ "Fn::Select" : [ "2", {"Fn::Split" : [ "-", { "Fn::Select": [ "0", {"Ref": "AZ"} ] }] }] }, "nacl" ]] } },
                  { "Key": "Environment", "Value": { "Ref": "Environment" } },
                  { "Key": "Network", "Value": "adm" }
              ]
          }
      },
	  "InboundAcl6": {
	      "Condition": "AdmExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "AdmNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "false",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      },

      "OutboundAcl6": {
	      "Condition": "AdmExists",
          "Type": "AWS::EC2::NetworkAclEntry",
          "Properties": {
              "NetworkAclId": { "Ref": "AdmNetworkAcl" },
              "RuleNumber": "100",
              "Protocol": "-1",
              "RuleAction": "allow",
              "Egress": "true",
              "CidrBlock": "0.0.0.0/0",
              "PortRange": { "From": "0", "To": "65535" }
          }
      }
  },

  "Outputs": {
    "VpcId": {
        "Description": "Id of the modified VPC",
        "Value": { "Ref": "VPCID" }
    },
	"DMZAcl": {
	    "Condition": "DMZExists",
        "Description": "Id of the DMZ ACL",
        "Value": { "Ref": "DMZNetworkAcl" }
    },
	"WebVIPAcl": {
	    "Condition": "WebVIPExists",
        "Description": "Id of the Web VIP ACL",
        "Value": { "Ref": "WebVIPNetworkAcl" }
    },
	"WebAcl": {
	    "Condition": "WebExists",
        "Description": "Id of the Web ACL",
        "Value": { "Ref": "WebNetworkAcl" }
    },
	"AppVIPAcl": {
	    "Condition": "AppVIPExists",
        "Description": "Id of the App VIP ACL",
        "Value": { "Ref": "AppVIPNetworkAcl" }
    },
	"AppAcl": {
	    "Condition": "AppExists",
        "Description": "Id of the App ACL",
        "Value": { "Ref": "AppNetworkAcl" }
    },
	"AdmAcl": {
	    "Condition": "AdmExists",
        "Description": "Id of the Admin ACL",
        "Value": { "Ref": "AdmNetworkAcl" }
    }
  }
}
